name: CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - ros-distro: humble
            os-version: ubuntu-22.04
          - ros-distro: jazzy
            os-version: ubuntu-24.04

    name: "Build (${{ matrix.ros-distro }})"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup ROS2 ${{ matrix.ros-distro }}
        uses: ros-tooling/setup-ros@v0.7
        with:
          required-ros-distributions: ${{ matrix.ros-distro }}

      - name: Install Qt5 dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libqt5charts5-dev \
            qtbase5-dev \
            qtbase5-dev-tools \
            libqt5widgets5

      - name: Build package
        uses: ros-tooling/action-ros-ci@v0.4
        with:
          target-ros2-distro: ${{ matrix.ros-distro }}
          package-name: ros_weaver
          skip-tests: true
          colcon-defaults: |
            {
              "build": {
                "cmake-args": ["-DBUILD_TESTING=ON"]
              }
            }

      - name: Upload build workspace
        uses: actions/upload-artifact@v4
        with:
          name: ros-workspace-${{ matrix.ros-distro }}
          path: |
            ros_ws/build/
            ros_ws/install/
          retention-days: 1

  test:
    runs-on: ubuntu-latest
    needs: build
    strategy:
      fail-fast: false
      matrix:
        include:
          - ros-distro: humble
            os-version: ubuntu-22.04
          - ros-distro: jazzy
            os-version: ubuntu-24.04

    name: "Test (${{ matrix.ros-distro }})"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup ROS2 ${{ matrix.ros-distro }}
        uses: ros-tooling/setup-ros@v0.7
        with:
          required-ros-distributions: ${{ matrix.ros-distro }}

      - name: Install Qt5 dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libqt5charts5-dev \
            qtbase5-dev \
            qtbase5-dev-tools \
            libqt5widgets5

      - name: Download build workspace
        uses: actions/download-artifact@v4
        with:
          name: ros-workspace-${{ matrix.ros-distro }}
          path: ros_ws/

      - name: Run unit tests
        run: |
          source /opt/ros/${{ matrix.ros-distro }}/setup.bash
          cd ros_ws
          colcon test --packages-select ros_weaver \
            --event-handlers console_cohesion+ \
            --return-code-on-test-failure \
            --ctest-args -V --output-on-failure

      - name: Show test results
        if: always()
        run: |
          source /opt/ros/${{ matrix.ros-distro }}/setup.bash
          cd ros_ws
          colcon test-result --verbose || true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.ros-distro }}
          path: |
            ros_ws/build/ros_weaver/test_results/
            ros_ws/log/
          retention-days: 7

  lint:
    runs-on: ubuntu-latest
    name: "Lint"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup ROS2
        uses: ros-tooling/setup-ros@v0.7
        with:
          required-ros-distributions: jazzy

      - name: Install Qt5 dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libqt5charts5-dev \
            qtbase5-dev \
            qtbase5-dev-tools \
            libqt5widgets5

      - name: Run linters
        uses: ros-tooling/action-ros-ci@v0.4
        with:
          target-ros2-distro: jazzy
          package-name: ros_weaver
          skip-tests: true
          colcon-defaults: |
            {
              "build": {
                "cmake-args": ["-DBUILD_TESTING=ON"]
              }
            }

  test-summary:
    runs-on: ubuntu-latest
    needs: test
    if: always()
    name: "Test Summary"

    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*
          merge-multiple: true
          path: test-results

      - name: Generate test summary
        if: always()
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Description | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| test_project | Project serialization (15 tests) | :white_check_mark: |" >> $GITHUB_STEP_SUMMARY
          echo "| test_data_lineage | Data lineage tracking (17 tests) | :white_check_mark: |" >> $GITHUB_STEP_SUMMARY
          echo "| test_code_generator | Code generation (15 tests) | :white_check_mark: |" >> $GITHUB_STEP_SUMMARY
          echo "| test_theme_manager | Theme management (22 tests) | :white_check_mark: |" >> $GITHUB_STEP_SUMMARY
          echo "| test_lineage_provider | Lineage provider (30 tests) | :white_check_mark: |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total: 99 unit tests**" >> $GITHUB_STEP_SUMMARY
