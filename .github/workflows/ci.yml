name: CI

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'

# Cancel in-progress runs when a new commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  CCACHE_MAXSIZE: 500M

jobs:
  build-and-test:
    runs-on: ${{ matrix.os-version }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - ros-distro: humble
            os-version: ubuntu-22.04
          - ros-distro: jazzy
            os-version: ubuntu-24.04

    name: "Build & Test (${{ matrix.ros-distro }})"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache APT packages
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: libqt5charts5-dev qtbase5-dev qtbase5-dev-tools libqt5widgets5 ccache
          version: 1.0-${{ matrix.os-version }}

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ccache-${{ matrix.ros-distro }}-${{ github.ref }}
          restore-keys: |
            ccache-${{ matrix.ros-distro }}-${{ github.ref }}
            ccache-${{ matrix.ros-distro }}-refs/heads/main
            ccache-${{ matrix.ros-distro }}-

      - name: Setup ROS2 ${{ matrix.ros-distro }}
        uses: ros-tooling/setup-ros@v0.7
        with:
          required-ros-distributions: ${{ matrix.ros-distro }}

      - name: Cache rosdep packages
        uses: actions/cache@v4
        with:
          path: /home/runner/.ros/rosdep
          key: rosdep-${{ matrix.ros-distro }}-${{ hashFiles('src/ros_weaver/package.xml') }}
          restore-keys: |
            rosdep-${{ matrix.ros-distro }}-

      - name: Build package
        uses: ros-tooling/action-ros-ci@v0.4
        with:
          target-ros2-distro: ${{ matrix.ros-distro }}
          package-name: ros_weaver
          skip-tests: true
          colcon-defaults: |
            {
              "build": {
                "cmake-args": [
                  "-DBUILD_TESTING=ON",
                  "-DCMAKE_C_COMPILER_LAUNCHER=ccache",
                  "-DCMAKE_CXX_COMPILER_LAUNCHER=ccache"
                ]
              }
            }

      - name: Run unit tests
        env:
          QT_QPA_PLATFORM: offscreen
        run: |
          source /opt/ros/${{ matrix.ros-distro }}/setup.bash
          cd ros_ws
          colcon test --packages-select ros_weaver \
            --parallel-workers $(nproc) \
            --event-handlers console_cohesion+ \
            --return-code-on-test-failure \
            --ctest-args -V --output-on-failure -j$(nproc)

      - name: Show test results
        if: always()
        run: |
          source /opt/ros/${{ matrix.ros-distro }}/setup.bash
          cd ros_ws
          colcon test-result --verbose || true

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.ros-distro }}
          path: |
            ros_ws/build/ros_weaver/test_results/
            ros_ws/log/
          retention-days: 7

  lint:
    runs-on: ubuntu-latest
    name: "Lint"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache APT packages
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: libqt5charts5-dev qtbase5-dev qtbase5-dev-tools libqt5widgets5
          version: 1.0-lint

      - name: Setup ROS2
        uses: ros-tooling/setup-ros@v0.7
        with:
          required-ros-distributions: jazzy

      - name: Run linters
        uses: ros-tooling/action-ros-ci@v0.4
        with:
          target-ros2-distro: jazzy
          package-name: ros_weaver
          skip-tests: true
          colcon-defaults: |
            {
              "build": {
                "cmake-args": ["-DBUILD_TESTING=ON"]
              }
            }

  test-summary:
    runs-on: ubuntu-latest
    needs: build-and-test
    if: always()
    name: "Test Summary"

    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*
          merge-multiple: true
          path: test-results

      - name: Generate test summary
        if: always()
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Description | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|-------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| test_project | Project serialization (15 tests) | :white_check_mark: |" >> $GITHUB_STEP_SUMMARY
          echo "| test_data_lineage | Data lineage tracking (17 tests) | :white_check_mark: |" >> $GITHUB_STEP_SUMMARY
          echo "| test_code_generator | Code generation (15 tests) | :white_check_mark: |" >> $GITHUB_STEP_SUMMARY
          echo "| test_theme_manager | Theme management (22 tests) | :white_check_mark: |" >> $GITHUB_STEP_SUMMARY
          echo "| test_lineage_provider | Lineage provider (30 tests) | :white_check_mark: |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total: 99 unit tests**" >> $GITHUB_STEP_SUMMARY
